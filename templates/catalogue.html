{% extends "base.html" %}

{% block title %}Parts Catalogue - WDP{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-box"></i> Parts Catalogue</h1>
</div>

<!-- Search and Filter Bar -->
<div class="card" style="margin-bottom: 2rem;">
    <!-- Main Search and Category Row -->
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; margin-bottom: 1rem;">
        <div style="flex: 1; min-width: 200px;">
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;">Search Parts</label>
            <form method="get" action="{{ url_for('catalogue') }}" style="display: flex; gap: 0.5rem;">
                <input type="search" name="search" placeholder="Search by part ID, name, or category…" value="{{ search_query or '' }}"
                       style="flex: 1; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
                <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem; white-space: nowrap;">
                    <i class="fas fa-search"></i> Search
                </button>
            </form>
        </div>
        <div style="flex: 1; min-width: 200px;">
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;">Category</label>
            <form method="get" action="{{ url_for('catalogue') }}" style="display: flex; gap: 0.5rem;">
                <select name="category"
                        style="flex: 1; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if cat == category_filter %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem; white-space: nowrap;">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </form>
        </div>
        <div>
            <a href="{{ url_for('catalogue') }}" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; text-decoration: none; display: inline-block; white-space: nowrap;">
                <i class="fas fa-redo"></i> Reset
            </a>
        </div>
    </div>
    
    <!-- Export and Import Buttons (Admin Only) -->
    {% if session.get('role') == 'admin' %}
    <div style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
            <a href="{{ url_for('export_catalogue') }}" class="btn btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-download"></i> Export CSV
            </a>
            <div style="flex: 1; min-width: 250px; display: flex; gap: 0.5rem;">
                <form method="post" action="{{ url_for('import_catalogue') }}" enctype="multipart/form-data" style="display: flex; gap: 0.5rem; align-items: center; flex: 1;">
                    <input type="file" name="file" accept=".csv,.xlsx,.xls" required style="flex: 1; padding: 0.5rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text); font-size: 0.9rem;">
                    <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem; white-space: nowrap;">
                        <i class="fas fa-upload"></i> Import
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Part Form (Admin Only) -->
{% if session.get('role') == 'admin' %}
<div class="card" style="margin-bottom: 2rem;">
    <h2 style="color: var(--accent); margin-bottom: 1.5rem;"><i class="fas fa-plus-circle"></i> Add New Part</h2>
    <form method="post" action="{{ url_for('catalogue') }}" enctype="multipart/form-data" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <input type="hidden" name="action" value="add_part">
        
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Part ID</label>
            <input type="text" name="part_id" placeholder="e.g. P001" required
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Part Name</label>
            <input type="text" name="name" placeholder="Part Name" required
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Category</label>
            <input type="text" name="category" placeholder="e.g. Brakes" required
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Price</label>
            <input type="number" name="price" placeholder="0.00" step="0.01" required
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Stock</label>
            <input type="number" name="stock" placeholder="0" required
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Image</label>
            <input type="file" name="image" accept="image/*"
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--muted-text);">
        </div>
        <div style="grid-column: span 2;">
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Description</label>
            <textarea name="description" placeholder="Part description…" rows="3"
                      style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="grid-column: span 2;">
            <i class="fas fa-plus"></i> Add Part
        </button>
    </form>
</div>
{% endif %}

<!-- Parts Grid/Table -->
<div class="card">
    <h2 style="color: var(--accent); margin-bottom: 1.5rem;"><i class="fas fa-list"></i> Available Parts</h2>
    {% if catalogue %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
        {% for part in catalogue %}
        <div style="background-color: rgba(255, 106, 61, 0.05); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; transition: all 0.3s ease; display: flex; flex-direction: column;">
            <!-- Product Image -->
            {% if part.get('image') %}
            <div style="width: 100%; height: 200px; background-color: var(--input-bg); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <img src="{{ part.image }}" alt="{{ part.name }}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            {% else %}
            <div style="width: 100%; height: 200px; background: linear-gradient(135deg, var(--accent) 0%, var(--action) 100%); display: flex; align-items: center; justify-content: center; color: white;">
                <i class="fas fa-box" style="font-size: 3rem;"></i>
            </div>
            {% endif %}

            <!-- Product Info -->
            <div style="padding: 1rem; flex: 1; display: flex; flex-direction: column;">
                <div style="margin-bottom: 0.5rem;">
                    <div style="font-size: 0.85rem; color: var(--action); font-weight: 500;">{{ part.part_id }}</div>
                    <h3 style="margin: 0.5rem 0; color: var(--text); font-size: 1rem;">{{ part.name }}</h3>
                </div>
                
                <div style="margin-bottom: 0.5rem;">
                    <span style="background-color: rgba(77, 212, 250, 0.2); color: var(--action); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                        {{ part.category }}
                    </span>
                </div>

                {% if part.description %}
                <p style="margin: 0.5rem 0; color: var(--muted-text); font-size: 0.9rem; line-height: 1.4; flex: 1;">{{ part.description[:80] }}{% if part.description|length > 80 %}...{% endif %}</p>
                {% endif %}

                <div style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <div>
                            <div style="color: var(--muted-text); font-size: 0.85rem;">Price</div>
                            <div style="color: var(--success); font-weight: bold; font-size: 1.3rem;">${{ "%.2f" | format(part.price) }}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--muted-text); font-size: 0.85rem;">Stock</div>
                            <div class="{% if part.stock > 10 %}stock-high{% elif part.stock > 0 %}stock-low{% else %}stock-empty{% endif %}" style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500;">
                                {{ part.stock }}
                            </div>
                        </div>
                    </div>

                    {% if session.get('role') == 'admin' %}
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                        <a href="{{ url_for('edit_catalogue_part', part_id=part.part_id) }}" class="btn btn-small" style="background-color: var(--action); color: var(--primary-bg); text-decoration: none; padding: 0.5rem 0.75rem; flex: 1; text-align: center; font-size: 0.9rem;">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <form method="post" action="{{ url_for('catalogue') }}" style="display: inline; flex: 1;" onsubmit="return confirm('Delete {{ part.name }}?');">
                            <input type="hidden" name="action" value="delete_part">
                            <input type="hidden" name="part_id" value="{{ part.part_id }}">
                            <button type="submit" class="btn btn-small" style="background-color: var(--danger); color: white; padding: 0.5rem 0.75rem; width: 100%; font-size: 0.9rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                    {% endif %}
                    
                    <!-- Add to Cart -->
                    <form method="post" action="{{ url_for('catalogue') }}" style="margin-top: 0.75rem;">
                        <input type="hidden" name="action" value="add_to_cart_from_catalogue">
                        <input type="hidden" name="part_id" value="{{ part.part_id }}">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" name="quantity" value="1" min="1" max="{{ part.stock }}" 
                                   style="width: 60px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text); text-align: center;">
                            <button type="submit" class="btn btn-small" style="background-color: var(--success); color: white; padding: 0.5rem 0.75rem; flex: 1; font-size: 0.9rem;" {% if part.stock == 0 %}disabled{% endif %}>
                                <i class="fas fa-shopping-cart"></i> Add to Cart
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="padding: 2rem; text-align: center; color: var(--muted-text);">
        <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
        <p>No parts found in catalogue.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
