{% extends "base.html" %}

{% block title %}Parts Catalogue - WDP{% endblock %}

{% block extra_css %}
<style>
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes countUp {
        from { opacity: 0; transform: scale(0.5); }
        to { opacity: 1; transform: scale(1); }
    }
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    @keyframes glow {
        0%, 100% { box-shadow: 0 0 5px rgba(255, 106, 61, 0.3); }
        50% { box-shadow: 0 0 20px rgba(255, 106, 61, 0.6); }
    }
    .stat-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        animation: fadeInUp 0.6s ease forwards;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent), var(--action), var(--success));
        background-size: 200% 100%;
        animation: shimmer 3s linear infinite;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(255, 106, 61, 0.2);
    }
    .stat-number {
        font-size: 2rem;
        font-weight: 800;
        animation: countUp 0.8s ease forwards;
    }
    .stock-bar {
        height: 8px;
        border-radius: 4px;
        background-color: var(--input-bg);
        overflow: hidden;
        margin-top: 0.5rem;
    }
    .stock-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 1s ease;
    }
    .recommendation-card {
        background-color: var(--card-bg);
        border: 1px solid rgba(77, 212, 250, 0.3);
        border-radius: 12px;
        padding: 1rem;
        transition: all 0.3s ease;
        animation: slideIn 0.5s ease forwards;
    }
    .recommendation-card:hover {
        transform: translateY(-3px);
        border-color: var(--accent);
        box-shadow: 0 6px 20px rgba(255, 106, 61, 0.15);
    }
    .ai-badge {
        background-color: #667eea;
        color: white;
        padding: 0.3rem 0.7rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        text-transform: uppercase;
    }
    .search-suggestion {
        display: inline-block;
        padding: 0.4rem 0.8rem;
        background-color: rgba(77, 212, 250, 0.15);
        border: 1px solid rgba(77, 212, 250, 0.4);
        border-radius: 20px;
        color: var(--action);
        text-decoration: none;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .search-suggestion:hover {
        background-color: rgba(77, 212, 250, 0.3);
        transform: scale(1.05);
        color: white;
    }
    .category-chart-bar {
        height: 28px;
        border-radius: 6px;
        transition: width 1.2s ease;
        display: flex;
        align-items: center;
        padding: 0 0.75rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--primary-bg);
        min-width: 40px;
    }
    .low-stock-alert {
        animation: pulse 2s infinite;
        background-color: rgba(234, 68, 90, 0.15);
        border: 1px solid var(--danger);
        border-radius: 10px;
        padding: 1rem;
    }
    .part-card-enhanced {
        background-color: rgba(255, 106, 61, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        animation: fadeInUp 0.5s ease forwards;
    }
    .part-card-enhanced:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        border-color: var(--accent);
    }
    .urgency-badge {
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <h1 class="page-title"><i class="fas fa-box"></i> Parts Catalogue</h1>
    <div style="display: flex; align-items: center; gap: 0.75rem;">
        <span class="ai-badge"><i class="fas fa-robot"></i> AI-Powered</span>
        <span style="color: var(--muted-text); font-size: 0.9rem;">{{ catalogue|length }} results</span>
    </div>
</div>

<!-- ==================== LOW STOCK ALERTS ==================== -->
{% if low_stock_parts and session.get('role') == 'admin' %}
<div class="low-stock-alert" style="margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
        <i class="fas fa-exclamation-triangle" style="color: var(--danger); font-size: 1.2rem;"></i>
        <span class="ai-badge" style="background-color: #ea445a;"><i class="fas fa-bell"></i> STOCK ALERT</span>
        <strong style="color: var(--danger);">{{ low_stock_parts|length }} part{{ 's' if low_stock_parts|length > 1 }} running low!</strong>
    </div>
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
        {% for part in low_stock_parts %}
        <div style="background-color: rgba(234, 68, 90, 0.1); border: 1px solid rgba(234, 68, 90, 0.3); border-radius: 8px; padding: 0.6rem 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="color: var(--text); font-weight: 500; font-size: 0.85rem;">{{ part.name }}</span>
            <span class="urgency-badge" style="background-color: rgba(234, 68, 90, 0.2); color: var(--danger);">
                <i class="fas fa-exclamation"></i> {{ part.stock }} left
            </span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if out_of_stock_parts and session.get('role') == 'admin' %}
<div style="margin-bottom: 2rem; background-color: rgba(234, 68, 90, 0.08); border: 1px solid rgba(234, 68, 90, 0.4); border-radius: 10px; padding: 1rem;">
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
        <i class="fas fa-ban" style="color: var(--danger);"></i>
        <strong style="color: var(--danger);">{{ out_of_stock_parts|length }} part{{ 's' if out_of_stock_parts|length > 1 }} out of stock:</strong>
    </div>
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        {% for part in out_of_stock_parts %}
        <span style="background-color: rgba(234, 68, 90, 0.15); color: var(--danger); padding: 0.3rem 0.7rem; border-radius: 6px; font-size: 0.85rem;">{{ part.name }}</span>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- ==================== SMART SEARCH & FILTER BAR ==================== -->
<div class="card" style="margin-bottom: 2rem;">
    <form method="get" action="{{ url_for('catalogue') }}" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
        <div style="flex: 2; min-width: 200px;">
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;"><i class="fas fa-brain"></i> Smart Search</label>
            <input type="search" name="search" placeholder="Search by Part ID, Name, Category   " value="{{ search_query or '' }}"
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div style="flex: 1; min-width: 150px;">
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;">Category</label>
            <select name="category"
                    style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if cat == category_filter %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="flex: 1; min-width: 150px;">
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;"><i class="fas fa-sort"></i> Sort By</label>
            <select name="sort"
                    style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
                <option value="">Default (Part ID)</option>
                <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                <option value="name_az" {% if sort_by == 'name_az' %}selected{% endif %}>Name: A to Z</option>
                <option value="name_za" {% if sort_by == 'name_za' %}selected{% endif %}>Name: Z to A</option>
                <option value="stock_low" {% if sort_by == 'stock_low' %}selected{% endif %}>Stock: Low to High</option>
                <option value="stock_high" {% if sort_by == 'stock_high' %}selected{% endif %}>Stock: High to Low</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i> Search
        </button>
        <a href="{{ url_for('catalogue') }}" class="btn btn-secondary">
            <i class="fas fa-redo"></i> Reset
        </a>
    </form>
</div>

<!-- ==================== SMART SEARCH SUGGESTIONS ==================== -->
{% if search_suggestions and search_query %}
<div class="card" style="margin-bottom: 2rem;  border-color: rgba(102, 126, 234, 0.3);">
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
        <span class="ai-badge"><i class="fas fa-lightbulb"></i> AI SUGGESTION</span>
        <span style="color: var(--muted-text); font-size: 0.9rem;">No exact matches for "<strong style="color: var(--action);">{{ search_query }}</strong>". Did you mean:</span>
    </div>
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        {% for suggestion in search_suggestions %}
        <a href="{{ url_for('catalogue', search=suggestion) }}" class="search-suggestion">
            <i class="fas fa-search"></i> {{ suggestion }}
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Add Part Form (Admin Only) -->
{% if session.get('role') == 'admin' %}
<div class="card" style="margin-bottom: 2rem;">
    <h2 style="color: var(--accent); margin-bottom: 1.5rem;"><i class="fas fa-plus-circle"></i> Add New Part</h2>
    <form method="post" action="{{ url_for('catalogue') }}" enctype="multipart/form-data" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <input type="hidden" name="action" value="add_part">
        
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Part ID</label>
            <input type="text" name="part_id" placeholder="e.g. P001" required
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Part Name</label>
            <input type="text" name="name" placeholder="Part name" required
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Category</label>
            <input type="text" name="category" placeholder="e.g. Electronic" required
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Price</label>
            <input type="number" name="price" placeholder="0.00" step="0.01" required
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Stock</label>
            <input type="number" name="stock" placeholder="0" required
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);">
        </div>
        <div>
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Image</label>
            <input type="file" name="image" accept="image/*"
                   style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--muted-text);">
        </div>
        <div style="grid-column: span 2;">
            <label style="color: var(--accent); display: block; margin-bottom: 0.5rem; font-weight: 500;">Description</label>
            <textarea name="description" placeholder="Part Description" rows="3"
                      style="width: 100%; padding: 0.75rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text);"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="grid-column: span 2;">
            <i class="fas fa-plus"></i> Add Part
        </button>
    </form>
</div>
{% endif %}

<!-- ==================== AI RECOMMENDATIONS ==================== -->
{% if recommendations and not search_query %}
<div class="card" style="margin-bottom: 2rem; border-color: rgba(77, 212, 250, 0.3);">
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
        <span class="ai-badge"><i class="fas fa-magic"></i> RECOMMENDED</span>
        <h3 style="color: var(--action); margin: 0; font-size: 1rem;">
            {% if cart_item_count > 0 %}
            <i class="fas fa-brain"></i> Recommended Parts Based On Your Cart
            {% else %}
            <i class="fas fa-star"></i> Recommended Parts Based On Availability
            {% endif %}
        </h3>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem;">
        {% for part in recommendations %}
        <div class="recommendation-card" style="animation-delay: {{ loop.index * 0.15 }}s;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <span style="color: var(--action); font-size: 0.8rem; font-weight: 600;">{{ part.part_id }}</span>
                <span style="background-color: rgba(77, 212, 250, 0.2); color: var(--action); padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">{{ part.category }}</span>
            </div>
            <h4 style="color: var(--text); margin: 0 0 0.5rem 0; font-size: 0.95rem;">{{ part.name }}</h4>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--success); font-weight: bold; font-size: 1.1rem;">${{ "%.2f" | format(part.price) }}</span>
                <form method="post" action="{{ url_for('catalogue') }}" style="display: inline;">
                    <input type="hidden" name="action" value="add_to_cart_from_catalogue">
                    <input type="hidden" name="part_id" value="{{ part.part_id }}">
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="btn btn-small" style="background-color: var(--success); color: white; padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                        <i class="fas fa-cart-plus"></i> Add
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- ==================== PARTS GRID ==================== -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: var(--accent); margin: 0;"><i class="fas fa-list"></i> Available Parts</h2>
        <span style="color: var(--muted-text); font-size: 0.85rem;">{{ catalogue|length }} part{{ 's' if catalogue|length != 1 }} found</span>
    </div>
    {% if catalogue %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
        {% for part in catalogue %}
        <div class="part-card-enhanced" style="animation-delay: {{ loop.index * 0.08 }}s;">
            <!-- Product Image -->
            {% if part.get('image') %}
            <div style="width: 100%; height: 200px; background-color: var(--input-bg); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;">
                <img src="{{ part.image }}" alt="{{ part.name }}" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease;">
                <!-- Stock urgency overlay -->
                {% if part.stock == 0 %}
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center;">
                    <span style="background-color: var(--danger); color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: bold;"><i class="fas fa-ban"></i> OUT OF STOCK</span>
                </div>
                {% elif part.stock <= 3 %}
                <div style="position: absolute; top: 10px; right: 10px;">
                    <span class="urgency-badge" style="background-color: rgba(234, 68, 90, 0.9); color: white;"><i class="fas fa-fire"></i> Only {{ part.stock }} left!</span>
                </div>
                {% elif part.stock <= 5 %}
                <div style="position: absolute; top: 10px; right: 10px;">
                    <span class="urgency-badge" style="background-color: rgba(255, 165, 0, 0.9); color: var(--primary-bg);"><i class="fas fa-exclamation"></i> Low Stock</span>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div style="width: 100%; height: 200px; background: linear-gradient(135deg, var(--accent) 0%, var(--action) 100%); display: flex; align-items: center; justify-content: center; color: white; position: relative;">
                <i class="fas fa-box" style="font-size: 3rem;"></i>
                {% if part.stock == 0 %}
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center;">
                    <span style="background-color: var(--danger); color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: bold;"><i class="fas fa-ban"></i> OUT OF STOCK</span>
                </div>
                {% elif part.stock <= 3 %}
                <div style="position: absolute; top: 10px; right: 10px;">
                    <span class="urgency-badge" style="background-color: rgba(234, 68, 90, 0.9); color: white;"><i class="fas fa-fire"></i> Only {{ part.stock }} left!</span>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Product Info -->
            <div style="padding: 1rem; flex: 1; display: flex; flex-direction: column;">
                <div style="margin-bottom: 0.5rem;">
                    <div style="font-size: 0.85rem; color: var(--action); font-weight: 500;">{{ part.part_id }}</div>
                    <h3 style="margin: 0.5rem 0; color: var(--text); font-size: 1rem;">{{ part.name }}</h3>
                </div>
                
                <div style="margin-bottom: 0.5rem;">
                    <span style="background-color: rgba(77, 212, 250, 0.2); color: var(--action); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                        {{ part.category }}
                    </span>
                </div>

                {% if part.description %}
                <p style="margin: 0.5rem 0; color: var(--muted-text); font-size: 0.9rem; line-height: 1.4; flex: 1;">{{ part.description[:80] }}{% if part.description|length > 80 %}...{% endif %}</p>
                {% endif %}

                <div style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div>
                            <div style="color: var(--muted-text); font-size: 0.85rem;">Price</div>
                            <div style="color: var(--success); font-weight: bold; font-size: 1.3rem;">${{ "%.2f" | format(part.price) }}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--muted-text); font-size: 0.85rem;">Stock</div>
                            <div style="font-weight: 500; font-size: 0.95rem; color: {% if part.stock > 10 %}var(--success){% elif part.stock > 0 %}var(--accent){% else %}var(--danger){% endif %};">
                                {{ part.stock }} units
                            </div>
                        </div>
                    </div>

                    <!-- Stock Health Bar -->
                    <div class="stock-bar">
                        {% set stock_pct = [part.stock * 4, 100]|min %}
                        <div class="stock-bar-fill" style="width: {{ stock_pct }}%; background: {% if part.stock > 10 %}linear-gradient(90deg, #19a974, #4dd4fa){% elif part.stock > 3 %}linear-gradient(90deg, #ffa500, #ff6a3d){% elif part.stock > 0 %}linear-gradient(90deg, #ea445a, #ff6a3d){% else %}var(--danger){% endif %};"></div>
                    </div>
                    <div style="font-size: 0.7rem; color: var(--muted-text); margin-top: 0.25rem; text-align: right;">
                        {% if part.stock > 10 %}
                        <span style="color: var(--success);"><i class="fas fa-check-circle"></i> Well Stocked</span>
                        {% elif part.stock > 5 %}
                        <span style="color: var(--action);"><i class="fas fa-info-circle"></i> Adequate Stock</span>
                        {% elif part.stock > 0 %}
                        <span style="color: var(--accent);"><i class="fas fa-exclamation-circle"></i> Restock Soon</span>
                        {% else %}
                        <span style="color: var(--danger);"><i class="fas fa-times-circle"></i> Needs Restock</span>
                        {% endif %}
                    </div>

                    <!-- Add to Cart (all users) -->
                    {% if part.stock > 0 %}
                    <form method="post" action="{{ url_for('catalogue') }}" style="display: flex; gap: 0.5rem; margin-top: 0.75rem; align-items: center;">
                        <input type="hidden" name="action" value="add_to_cart_from_catalogue">
                        <input type="hidden" name="part_id" value="{{ part.part_id }}">
                        <input type="number" name="quantity" value="1" min="1" max="{{ part.stock }}"
                               style="width: 60px; padding: 0.5rem; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text); text-align: center;">
                        <button type="submit" class="btn btn-small" style="background-color: var(--success); color: white; padding: 0.5rem 0.75rem; flex: 1; font-size: 0.9rem;">
                            <i class="fas fa-cart-plus"></i> Add to Cart
                        </button>
                    </form>
                    {% else %}
                    <div style="margin-top: 0.75rem; text-align: center; padding: 0.5rem; background-color: rgba(234, 68, 90, 0.1); border-radius: 6px; color: var(--danger); font-size: 0.9rem;">
                        <i class="fas fa-ban"></i> Out of Stock
                    </div>
                    {% endif %}

                    {% if session.get('role') == 'admin' %}
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <a href="{{ url_for('edit_catalogue_part', part_id=part.part_id) }}" class="btn btn-small" style="background-color: var(--action); color: var(--primary-bg); text-decoration: none; padding: 0.5rem 0.75rem; flex: 1; text-align: center; font-size: 0.9rem;">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <form method="post" action="{{ url_for('catalogue') }}" style="display: inline; flex: 1;" onsubmit="return confirm('Delete {{ part.name }}?');">
                            <input type="hidden" name="action" value="delete_part">
                            <input type="hidden" name="part_id" value="{{ part.part_id }}">
                            <button type="submit" class="btn btn-small" style="background-color: var(--danger); color: white; padding: 0.5rem 0.75rem; width: 100%; font-size: 0.9rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="padding: 3rem; text-align: center; color: var(--muted-text);">
        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; display: block; color: var(--border-color);"></i>
        {% if search_query %}
        <p style="font-size: 1.1rem;">No parts match "<strong style="color: var(--action);">{{ search_query }}</strong>"</p>
        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Try a different search term or check the AI suggestions above.</p>
        {% else %}
        <p style="font-size: 1.1rem;">No parts found in catalogue.</p>
        {% endif %}
        <a href="{{ url_for('catalogue') }}" class="btn btn-primary" style="margin-top: 1rem;">
            <i class="fas fa-redo"></i> View All Parts
        </a>
    </div>
    {% endif %}
</div>

<!-- ==================== AI ANALYTICS DASHBOARD (Admin Only) ==================== -->
{% if session.get('role') == 'admin' %}
<div class="card" style="margin-bottom: 2rem; ">
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.25rem;">
        <span class="ai-badge"><i class="fas fa-chart-line"></i> ANALYTICS</span>
        <h2 style="color: var(--accent); margin: 0; font-size: 1.1rem;">Inventory Intelligence Dashboard</h2>
    </div>
    
    <!-- Stats Cards Row -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div class="stat-card" style="animation-delay: 0.1s;">
            <div style="color: var(--action); margin-bottom: 0.5rem;"><i class="fas fa-boxes" style="font-size: 1.5rem;"></i></div>
            <div class="stat-number" style="color: var(--accent);">{{ total_parts }}</div>
            <div style="color: var(--muted-text); font-size: 0.8rem; margin-top: 0.25rem;">Total Parts</div>
        </div>
        <div class="stat-card" style="animation-delay: 0.2s;">
            <div style="color: var(--success); margin-bottom: 0.5rem;"><i class="fas fa-warehouse" style="font-size: 1.5rem;"></i></div>
            <div class="stat-number" style="color: var(--success);">{{ total_stock }}</div>
            <div style="color: var(--muted-text); font-size: 0.8rem; margin-top: 0.25rem;">Units in Stock</div>
        </div>
        <div class="stat-card" style="animation-delay: 0.3s;">
            <div style="color: var(--accent); margin-bottom: 0.5rem;"><i class="fas fa-dollar-sign" style="font-size: 1.5rem;"></i></div>
            <div class="stat-number" style="color: var(--accent);">${{ "%.0f" | format(total_value) }}</div>
            <div style="color: var(--muted-text); font-size: 0.8rem; margin-top: 0.25rem;">Inventory Value</div>
        </div>
        <div class="stat-card" style="animation-delay: 0.4s;">
            <div style="color: var(--action); margin-bottom: 0.5rem;"><i class="fas fa-tag" style="font-size: 1.5rem;"></i></div>
            <div class="stat-number" style="color: var(--action);">${{ "%.0f" | format(avg_price) }}</div>
            <div style="color: var(--muted-text); font-size: 0.8rem; margin-top: 0.25rem;">Avg Price</div>
        </div>
        <div class="stat-card" style="animation-delay: 0.5s;">
            <div style="margin-bottom: 0.5rem;">
                {% if low_stock_parts|length > 0 %}
                <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: var(--danger);"></i>
                {% else %}
                <i class="fas fa-check-circle" style="font-size: 1.5rem; color: var(--success);"></i>
                {% endif %}
            </div>
            <div class="stat-number" style="color: {% if low_stock_parts|length > 0 %}var(--danger){% else %}var(--success){% endif %};">{{ low_stock_parts|length }}</div>
            <div style="color: var(--muted-text); font-size: 0.8rem; margin-top: 0.25rem;">Low Stock Alerts</div>
        </div>
    </div>

    <!-- Category Distribution Chart -->
    {% if category_stats %}
    <div style="background-color: rgba(0,0,0,0.2); border-radius: 10px; padding: 1.25rem;">
        <h3 style="color: var(--action); font-size: 0.95rem; margin-bottom: 1rem;"><i class="fas fa-chart-bar"></i> Category Distribution</h3>
        {% set max_count = category_stats.values()|map(attribute='count')|max %}
        {% for cat, stats in category_stats.items() %}
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.6rem; animation: slideIn 0.5s ease forwards; animation-delay: {{ loop.index * 0.1 }}s; opacity: 0;">
            <div style="min-width: 100px; font-size: 0.85rem; color: var(--muted-text); text-align: right;">{{ cat }}</div>
            <div style="flex: 1; position: relative;">
                <div class="category-chart-bar" style="width: {{ (stats.count / max_count * 100)|int }}%; background-color: var(--accent);">
                    {{ stats.count }}
                </div>
            </div>
            <div style="min-width: 80px; font-size: 0.8rem; color: var(--muted-text);">{{ stats.total_stock }} units</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

{% endif %}
{% endblock %}
